{% extends 'authentication/_base.html' %}
{% load static %}
{% block content %}

    <div class="row">
        <div class="col-sm-4">

        </div>
        <div class="col-sm-4">
            <div class="container mt-5">
                <div class="card">
                    <div class="card-header">
                        Register
                    </div>
                    <div class="card-body">
                        <form action="{% url 'authentication:register' %}" method="post">
                            {% csrf_token %}
                            <div class="form-group mb-2">
                                <input class="form-control form-control-sm"
                                       name="username" id="usernameField" value="{{ username }}" type="text"
                                       placeholder="Username">
                            </div>
                            <div class="invalid-feedback username" style="display:none">

                            </div>
                            <div class="form-group mb-2">
                                <input class="form-control form-control-sm" name="email"
                                       id="emailField" value="{{ email }}" type="email" placeholder="Email">
                            </div>
                            <div class="invalid-feedback email" style="display:none">
                            </div>
                            <div class="form-group mb-2">
                                <input class="form-control form-control-sm"
                                       name="password" id="passwordField"
                                       type="password" placeholder="Password">
                            </div>
                            <div class="form-group mb-3">
                                <small class="float-end text-secondary showPasswordToggle"
                                       style="cursor: pointer; text-decoration: underline">Show password</small>
                            </div>
                            <div class="form-group pt-3">
                                <button class="btn btn-outline-secondary submit-btn" type="submit" value="Register">
                                    Register
                                </button>
                                <span>Already have an account?</span>
                                <a href="{% url 'authentication:login' %}">Login</a>
                            </div>

                        </form>
                    </div>
                </div>
            </div>
        </div>
    </div>

{% endblock content %}
{% block js_script %}
    <script>
        const usernameField = document.querySelector('#usernameField');
        const feedBackFeedUsername = document.querySelector(".username");

        const emailField = document.querySelector('#emailField');
        const feedBackFeedEmail = document.querySelector('.email');

        const passwordField = document.querySelector('#passwordField');
        const showPasswordToggle = document.querySelector('.showPasswordToggle');

        const submitBtn = document.querySelector('.submit-btn');

        const handleShowPasswordToggle = (event) => {
            if (showPasswordToggle.textContent === 'Show password') {
                showPasswordToggle.textContent = 'Hide password';
                passwordField.setAttribute("type", "text");
            } else {
                showPasswordToggle.textContent = 'Show password';
                passwordField.setAttribute("type", "password");
            }

        };

        usernameField.addEventListener('keyup', (event) => {
            // catch username value from input field
            const username = event.target.value;

            usernameField.classList.remove("is-invalid");
            feedBackFeedUsername.style.display = "none";

            if (username.length > 0) {
                // make api call
                fetch('/authentication/validate-username', {
                    body: JSON.stringify({username: username}),
                    method: 'POST',

                })
                    .then((response) => response.json())
                    .then((data) => {
                        if (data.username_error) {
                            submitBtn.disabled = true;
                            usernameField.classList.add("is-invalid");
                            feedBackFeedUsername.style.display = 'block';
                            feedBackFeedUsername.innerHTML = `<p>${data.username_error}</p>`;
                        } else {
                            submitBtn.removeAttribute("disabled");
                        }
                    })
            }
        });

        emailField.addEventListener('keyup', (event) => {
            const email = event.target.value;

            emailField.classList.remove('is-invalid');
            feedBackFeedEmail.style.display = 'none';

            if (email.length > 0) {
                fetch('/authentication/validate-email', {
                    body: JSON.stringify({email: email}),
                    method: 'POST',
                })
                    .then((response) => response.json())
                    .then((data) => {
                        if (data.email_error) {
                            submitBtn.disabled = true;
                            emailField.classList.add('is-invalid');
                            feedBackFeedEmail.style.display = 'block';
                            feedBackFeedEmail.innerHTML = `<p>${data.email_error}</p>`
                        } else {
                            submitBtn.removeAttribute("disabled");
                        }
                    })
            }
        });

        showPasswordToggle.addEventListener('click', handleShowPasswordToggle);
    </script>
{% endblock js_script %}